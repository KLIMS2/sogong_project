<html layout:decorate="~{layout/layout.html}">
    <body>
        <section layout:fragment="content">
            <h1>join</h1>

            <form th:action="@{/member/join}"
                  method="post"
                  id="joinForm"
                  th:object="${memberForm}"
                  class="flex flex-col gap-2">
                <div class="flex flex-col">
                    <label for="username">아이디</label>
                    <div class="flex">
                        <input type="text"
                               th:field="*{username}"
                               placeholder="아아디"
                               oninput="hideValidator('validator-username');"
                               class="input"/>

                        <!-- 아이디 중복 확인용 -->
                        <button type="button" onclick="checkForm('true')" class="btn ml-2 mr-2">
                            중복 확인
                        </button>
                        <div th:if="${isValid != null}" class="validator-username">
                            <div th:if="${isValid}"
                                 class="flex items-center justify-center bg-[#00aa0055] border h-10 w-16">
                                가능
                            </div>
                            <div th:unless="${isValid}"
                                 class="flex items-center justify-center bg-[#aa000055] border h-10 w-16">
                                불가능
                            </div>
                        </div>
                    </div>
                </div>
                <div th:if="${isValid == null}" class="validator-username">
                    <div th:replace="~{error/error :: form(username)}"></div>
                </div>

                <div class="flex flex-col">
                    <label for="password">비밀번호</label>
                    <input type="password"
                           th:field="*{password}"
                           placeholder="비밀번호"
                           oninput="hideValidator('validator-password');"
                           class="input"/>
                </div>
                <div th:if="${isValid == null}" class="validator-password">
                    <div th:replace="~{error/error :: form(password)}"></div>
                </div>

                <div class="flex flex-col">
                    <label for="passwordConfirm">비밀번호 확인</label>
                    <input type="password"
                           th:field="*{passwordConfirm}"
                           placeholder="비밀번호 확인"
                           oninput="hideValidator('validator-passwordConfirm');"
                           class="input"/>
                </div>
                <div th:if="${isValid == null}" class="validator-passwordConfirm">
                    <div th:replace="~{error/error :: form(passwordConfirm)}"></div>
                </div>

                <input hidden type="text" th:field="*{checkUsername}">
                <div>
                    <button type="button" onclick="checkForm('false')" class="btn">제출</button>
                </div>
            </form>

            <script th:inline="javascript">
                // 뒤로가기로 페이지 접근 방지
                window.onpageshow = function(event) {
                    if (event.persisted || (window.performance && window.performance.navigation.type === 2))
                    {
                        location.replace('/');
                    }
                };

                function checkForm(bool)
                {
                    const form = document.getElementById('joinForm');

                    // checkUsername 필드값 결정
                    const checkUsername = form.checkUsername;
                    checkUsername.value = bool;

                    // 아이디 확인
                    form.username.value = form.username.value.trim();
                    const username = form.username.value;
                    const min_username = [[${input_size.username.min}]];
                    const max_username = [[${input_size.username.max}]];

                    if (username === "")
                    {
                        alert("아이디를 입력해주세요.");
                        form.username.focus();
                        return;
                    }
                    else if(username.length < min_username || username.length > max_username)
                    {
                        alert(`아이디의 크기는 ${min_username} ~ ${max_username} 사이여야 합니다`);
                        form.username.focus();
                        return;
                    }

                    if(bool === 'false')
                    {
                        // 비밀번호 확인
                        form.password.value = form.password.value.trim();
                        const password = form.password.value;
                        const min_password = [[${input_size.password.min}]];
                        const max_password = [[${input_size.password.max}]];

                        if (password === "")
                        {
                            alert("비밀번호를 입력해주세요.");
                            form.password.focus();
                            return;
                        }
                        else if(password.length < min_password || password.length > max_password)
                        {
                            alert(`비밀번호의 크기는 ${min_password} ~ ${max_password} 사이여야 합니다`);
                            form.password.focus();
                            return;
                        }

                        // 확인 비밀번호 확인
                        form.passwordConfirm.value = form.passwordConfirm.value.trim();
                        const passwordConfirm = form.passwordConfirm.value;
                        const min_passwordConfirm = [[${input_size.passwordConfirm.min}]];
                        const max_passwordConfirm = [[${input_size.passwordConfirm.max}]];

                        if (passwordConfirm === "")
                        {
                            alert("확인 비밀번호를 입력해주세요.");
                            form.passwordConfirm.focus();
                            return;
                        }
                        else if(passwordConfirm.length < min_passwordConfirm || passwordConfirm.length > max_passwordConfirm)
                        {
                            alert(`확인 비밀번호의 크기는 ${min_passwordConfirm} ~ ${max_passwordConfirm} 사이여야 합니다`);
                            form.passwordConfirm.focus();
                            return;
                        }

                        // 비밀번호 일치 여부 확인
                        if(password !== passwordConfirm)
                        {
                            alert("비밀번호가 일치하지 않습니다.");
                            form.passwordConfirm.focus();
                            return;
                        }
                    }

                    // 폼 제출
                    form.submit();
                }

                function hideValidator(validatorClass)
                {
                    const validators = document.getElementsByClassName(validatorClass);
                    Array.from(validators).forEach(validator => {
                        validator.style.display = 'none';
                    });
                }
            </script>
        </section>
    </body>
</html>